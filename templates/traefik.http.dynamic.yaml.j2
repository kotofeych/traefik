---
http:
  routers:
    http_{{ item.name }}:
{% if item.raw_domain is defined and item.raw_domain %}
      rule: {{ item.raw_domain }}
{% elif item.domain is defined and item.domain %}
      rule: Host(`{{ item.domain }}`)
{% endif %}
      entrypoints:
        - http
      service: {{ item.name }}
{% if item.tls is defined or item.tls_resolver is defined %}
      middlewares:
      - redirect-http-to-https
    https_{{ item.name }}:
{% if item.raw_domain is defined and item.raw_domain %}
      rule: {{ item.raw_domain }}
{% elif item.domain is defined and item.domain %}
      rule: Host(`{{ item.domain }}`)
{% endif %}
      entrypoints:
        - https
      service: {{ item.name }}
{% if item.tls is defined and item.tls_resolver is undefined %}
      tls: {{ item.tls | to_nice_yaml(explicit_start=False, explicit_end=False) }}
{% elif item.tls_resolver is defined and item.tls_resolver %}
      tls:
        certResolver: default_le_resolver
        domains:
          - main: {{ item.tls_resolver.main }}
            sans:
              - '{{ item.tls_resolver.sans }}'
{%- endif %}
{%- endif %}

  services:
    {{ item.name }}:
      loadBalancer:
        servers:
          - url: {{ item.services_url }}
