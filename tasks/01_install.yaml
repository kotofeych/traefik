---
- name: Create directories
  become: true
  file:
    path: "/etc/traefik/{{ item.name }}"
    state: directory
    mode: 0644
  with_items:
    - "{{ traefik_subdirectory }}"
  changed_when: false
  register: create_dir

- name: Template - unit systemd
  become: true
  template:
    src: "traefik.service.j2"
    dest: "/etc/systemd/system/traefik.service"
    mode: 0644
  notify:
    - restart_traefik

- name: Temlate - traefik config
  become: true
  template:
    src: "traefik.yaml.j2"
    dest: "/etc/traefik/traefik.yaml"
    mode: 0644
  notify:
    - restart_traefik

- name: Temlate - traefik global dynamic config
  become: true
  template:
    src: "_global.yaml.j2"
    dest: "/etc/traefik/config/dynamic/_global.yaml"
    mode: 0644
  changed_when: false

- name: Template - traefik typical HTTP dynamic config
  become: true
  template:
    src: "traefik.http.dynamic.yaml.j2"
    dest: "/etc/traefik/config/dynamic/{{ item.name }}_http.yaml"
    mode: 0644
  when: traefik_http_dynamic_config is defined and traefik_http_dynamic_config
  with_items:
    - "{{ traefik_http_dynamic_config }}"
  changed_when: false
  register: create_config

- name: Template - traefik custom HTTP and HTTPS config
  become: true
  template:
    src: "traefik.http_and_https.dynamic.yaml.j2"
    dest: "/etc/traefik/config/dynamic/{{ item.name }}_https.yaml"
    mode: 0644
  when: traefik_http_and_https_config is defined and traefik_http_and_https_config
  with_items:
    - "{{ traefik_http_and_https_config }}"
  changed_when: false

- name: Template - traefik typical TCP dynamic config
  become: true
  template:
    src: "traefik.tcp.dynamic.yaml.j2"
    dest: "/etc/traefik/config/dynamic/{{ item.name }}_tcp.yaml"
    mode: 0644
  when: traefik_tcp_dynamic_config is defined and traefik_tcp_dynamic_config
  with_items:
    - "{{ traefik_tcp_dynamic_config }}"
  changed_when: false

- name: Copy cert files for https
  become: true
  copy:
    content: "{{ item.content }}"
    dest: "{{ traefik_tls_dir }}{{ item.file }}"
    mode: 0644
  with_items: "{{ traefik_tls_cert_default }}"
  when: traefik_tls_cert and traefik_tls_key
  changed_when: false
